<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>amis admin</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
    <link rel="stylesheet" title="default" href="  {{ static(path='public/amis/sdk/sdk.css') }}"/>
    <link rel="stylesheet" href="{{ static(path='public/amis/sdk/helper.css') }}"/>
    <script src="{{ static(path='public/amis/sdk/sdk.js') }}"></script>
    <script src="{{ static(path='public/vue2.js') }}"></script>
    <script src="{{ static(path='public/amis/axios.js') }}"></script>
    <style>
        html,
        body,
        .app-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="login">
    <h1>登录</h1>
    <input type="text" required="required" placeholder="用户名" name="username" id="username"></input>
    <input type="password" required="required" placeholder="密码" name="password"
           id="password"></input>
    <button class="but" onclick="login()">登录</button>
</div>
<div id="root" class="app-wrapper"></div>
<script>
    {% if access_token %}
    function start() {
    document.getElementById('login').remove();
    main('{{access_token}}')
    }
    start()
    {% else %}
    function login() {
        axios(
            {
                method: 'post',
                url: "/fast/auth/index",
                data: {
                    "username": document.getElementById("username").value,
                    "password": document.getElementById("password").value
                },
                headers: {'Content-Type': 'application/json'}
            }
        ).then(function (response) {
            data = response.data
            document.getElementById('login').remove();
            main(data.access_token)
        }).catch(function (error) {
            console.log(error);
        });
    }
    {% endif %}
    function main(access_token) {
        console.log(access_token)
        let amis = amisRequire("amis/embed");
        const app = {
            type: "app",
            brandName: "Admin",
            logo: "{{ static (path='public/logo.png') }}",
            // header: {
            //     type: "tpl",
            //     inline: false,
            //     className: "w-full",
            //     tpl:
            //         '<div class="flex justify-between"><div>顶部区域左侧</div><div>顶部区域右侧</div></div>',
            // },
            // footer: '<div class="p-2 text-center bg-light">底部区域</div>',
            // asideBefore: '<div class="p-2 text-center">菜单前面区域</div>',
            // asideAfter: '<div class="p-2 text-center">菜单后面区域</div>',
            api: "/fast/auth/site",
        };

        function normalizeLink(to, location = window.location) {
            to = to || "";
            if (to && to[0] === "#") {
                to = location.pathname + location.search + to;
            } else if (to && to[0] === "?") {
                to = location.pathname + to;
            }

            const idx = to.indexOf("?");
            const idx2 = to.indexOf("#");
            let pathname = ~idx
                ? to.substring(0, idx)
                : ~idx2
                    ? to.substring(0, idx2)
                    : to;
            let search = ~idx ? to.substring(idx, ~idx2 ? idx2 : undefined) : "";
            let hash = ~idx2 ? to.substring(idx2) : location.hash;

            if (!pathname) {
                pathname = location.pathname;
            } else if (pathname[0] != "/" && !/^https?\:\/\//.test(pathname)) {
                let relativeBase = location.pathname;
                const paths = relativeBase.split("/");
                paths.pop();
                let m;
                while ((m = /^\.\.?\//.exec(pathname))) {
                    if (m[0] === "../") {
                        paths.pop();
                    }
                    pathname = pathname.substring(m[0].length);
                }
                pathname = paths.concat(pathname).join("/");
            }
            return pathname + search + hash;
        }

        const match = amisRequire("path-to-regexp").match;

        let amisScoped = amis.embed(
            "#root",
            app,
            {},
            {
                watchRouteChange: fn => {
                    window.addEventListener("hashchange", fn);
                    return () => {
                        window.removeEventListener("hashchange", fn);
                    };
                },
                jumpTo: to => {
                    location.hash = to;
                },
                updateLocation: (to, replace) => {
                },
                responseAdpater(api, response, query, request) {//增加一个登陆弹框
                    return response;
                },
                fetcher: ({url, method, data, config, headers}) => {
                    config = config || {};
                    config.headers = headers || {};
                    config.headers["Authorization"] = "Bearer " + access_token
                    let success=config.onSuccess
                    console.log(success)
                    console.log(config)
                    // config.onSuccess=function (){
                    //
                    // }
                    if (config.cancelExecutor) {
                        config.cancelToken = new axios.CancelToken(config.cancelExecutor);
                    }
                    if (data && data instanceof FormData) {
                        // config.headers = config.headers || {};
                        // config.headers['Content-Type'] = 'multipart/form-data';
                    } else if (
                        data &&
                        typeof data !== 'string' &&
                        !(data instanceof Blob) &&
                        !(data instanceof ArrayBuffer)
                    ) {
                        data = JSON.stringify(data);
                        config.headers['Content-Type'] = 'application/json';
                    }

                    if (method !== 'post' && method !== 'put' && method !== 'patch') {
                        if (data) {
                            if (method === 'delete') {
                                config.data = data;
                            } else {
                                config.params = data;
                            }
                        }
                        return axios[method](url, config);
                    }
                    return axios[method](url, data, config);
                },
                isCurrentUrl: (to, ctx) => {
                    if (!to) {
                        return false;
                    }
                    const pathname = location.hash ? location.hash.substring(1) : "/";
                    const link = normalizeLink(to, {
                        ...location,
                        pathname,
                        hash: "",
                    });

                    if (!~link.indexOf("http") && ~link.indexOf(":")) {
                        return match(link, {
                            decode: decodeURIComponent,
                            strict: ctx?.strict ?? true,
                        })(pathname);
                    }
                    return pathname === link;
                },
                theme:'default'
            }
        );
    }
</script>
</body>
</html>
